# TesterDBS

A tool for automating the testing process for database assignments in the Database Technologies course at the Slovak
University of Technology.

The tool operates by listening on a Redis queue where it retrieves tasks in JSON format. These tasks include
details about the student's Docker container, the assignment, and the specific scenarios required for the assignment.

Upon receiving a task, the tool creates a sandbox environment using Docker based on the student's container.
It then executes predefined testing scenarios, which involve making HTTP requests and verifying the responses
against expected outcomes. The tool compares the actual responses generated by the student's Docker image with
the expected responses specified in the task. To optimize its operations, the tool leverages Docker and Redis
for efficient processing of tasks and results. 

After performing the tests, the tool pushes the output comprising the comparison results of the actual 
and expected responses to a Redis queue. This output then awaits processing by another application 
that pushes results to database.

## Install

Application use these environments variables:

| Variable                 | Description                              | Default                           | Example                            |
|--------------------------|------------------------------------------|-----------------------------------|------------------------------------|
| `DATABASE_HOST`          | Database server location                 | -                                 | `docker.for.mac.localhost`         |
| `DATABASE_NAME`          | Database name                            | -                                 | `tester`                           |
| `DATABASE_PASSWORD`      | Database user password                   | `super-secure-password`           |                                    |
| `DATABASE_PORT`          | Database port                            | `5432`                            | `5432`                             |
| `DATABASE_USER`          | Database user                            | -                                 | `tester`                           |
| `DJANGO_SETTINGS_MODULE` | Django Settings Module                   | `dbs_tester.settings.development` | `dbs_tester.settings.production`   |
| `REDIS_HOST`             | Redis host                               | `host.docker.internal`            | `host.docker.internal`             |
| `REDIS_PORT`             | Redis port                               | `6379`                            | `6379`                             |
| `REDIS_PASSWORD`         | Redis password                           | -                                 |                                    |
| `RQ_REDIS_DB`            | Redis database                           | `0`                               | `0`                                |
| `SECRET_KEY`             | Django secret                            | -                                 | `ghp_asdqwjdsncvsdv`               |
| `GITHUB_TOKEN`           | GitHub token                             | -                                 | `Secure-random-string-21`          |
| `GITHUB_USER`            | GitHub username                          | -                                 | `Sibyx`                            |
| `DBS_DOCKER_NETWORK`     | Docker network for assignment containers | `dbs`                             | `dbs`                              |

### Docker

Dockerfile contains one target:

- runner

Example of configuration is present in `compose.yml`.

The container require access to the Docker environment that's why you have to create volume, which maps a path to the
Docker socket.

Repository contains an example of the **systemd unit script** in the `conf/tester-dbs.service`.

### From source

We use [poetry](https://python-poetry.org/) for dependency management and [PostgreSQL](https://www.postgresql.org/) 15
(10+ should be compatible) as a data storage (acquisition files are stored on the filesystem, not in the database).
To set up instance with demo database follow these simple steps:

1. Create python virtual environment (`python -m venv venv`)
2. Enter environment (`source venv/bin/activate`)
3. Install dependencies `poetry install`
4. Create `.env` file according `.env.example`
5. Execute runner `python manage.py runner --processes {number of processes}`

## Known issues
- ERROR: tuple concurrently updated (possible when same task executed multiple times)
- Scenario depends_on property (if assignment contains only one scenario and it has dependency
  which is not present in scenario list, it should not be executed) 

## Docs

For more information check the `docs` directory.

---
![](docs/fiit.png)

Made with ❤️ and ☕️ FIIT STU (c) 2022-2024
